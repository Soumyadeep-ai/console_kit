name: Code Quality Suite

on:
  pull_request:
    branches: [master]

permissions:
  contents: read
  pull-requests: write

jobs:
  test-and-quality:
    runs-on: ubuntu-latest
    name: Run Tests and Code Quality Checks

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.4.4

      - name: Install dependencies
        run: bundle install

      # RSpec
      - name: Run RSpec
        id: rspec
        run: |
          bundle exec rspec --format documentation | tee rspec_result.txt

      - name: Extract RSpec summary
        id: rspec_summary
        run: |
          summary=$(tail -n 20 rspec_result.txt | grep -E 'examples?,|failures?|pending?' | tr '\n' ' ')
          passed=$(echo "$summary" | awk '{ for(i=1;i<=NF;i++) if($i ~ /examples?/) print $(i-1) }')
          failed=$(echo "$summary" | awk '{ for(i=1;i<=NF;i++) if($i ~ /failures?/) print $(i-1) }')
          echo "passed=${passed}" >> $GITHUB_OUTPUT
          echo "failed=${failed}" >> $GITHUB_OUTPUT
          echo "summary=${summary}" >> $GITHUB_OUTPUT

      # Rubocop
      - name: Run Rubocop
        id: rubocop
        run: |
          rubocop_output=$(bundle exec rubocop)
          echo "$rubocop_output" | tee rubocop_result.txt
          summary=$(echo "$rubocop_output" | grep 'files inspected')
          echo "summary=${summary}" >> $GITHUB_OUTPUT

      # Reek
      - name: Run Reek
        id: reek
        run: |
          reek_output=$(bundle exec reek || true)
          echo "$reek_output" | tee reek_result.txt
          total=$(echo "$reek_output" | grep -c '^  ')
          echo "total_warnings=${total}" >> $GITHUB_OUTPUT

      # Comment on PR
      - name: Comment test and quality results on PR
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ### âœ… Code Quality Check Summary

            #### ğŸ” RSpec
            | Success | Failure |
            |--------:|--------:|
            | ${{ steps.rspec_summary.outputs.passed }} | ${{ steps.rspec_summary.outputs.failed }} |

            #### ğŸ§¹ Rubocop
            `${{ steps.rubocop.outputs.summary }}`

            #### ğŸ‘ƒ Reek
            `${{ steps.reek.outputs.total_warnings }} total warnings`
