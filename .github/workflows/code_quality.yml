name: Code Quality Check

on:
  pull_request:
    branches: [master]

permissions:
  contents: read
  pull-requests: write

jobs:
  quality:
    name: Run RSpec and Rubocop
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.4.4

      - name: Install dependencies
        run: bundle install

      ########################################
      # Run RSpec and capture summary
      ########################################
      - name: Run RSpec
        id: rspec
        run: |
          bundle exec rspec --format documentation | tee rspec_result.txt

          summary_line=$(grep -E '[0-9]+ examples?, [0-9]+ failures?' rspec_result.txt | tail -n 1)

          passed=$(echo "$summary_line" | awk '{print $1}')
          failed=$(echo "$summary_line" | awk '{print $3}')
          summary=$(echo "$summary_line")

          echo "passed=${passed}" >> $GITHUB_OUTPUT
          echo "failed=${failed}" >> $GITHUB_OUTPUT
          echo "summary=${summary}" >> $GITHUB_OUTPUT

      ########################################
      # Run Rubocop and capture summary
      ########################################
      - name: Run Rubocop
        id: rubocop
        run: |
          rubo_output=$(bundle exec rubocop || true)
          echo "$rubo_output" | tee rubocop_result.txt
          summary=$(echo "$rubo_output" | grep 'files inspected')
          echo "summary=${summary}" >> $GITHUB_OUTPUT

      ########################################
      # Post a PR comment with all summaries
      ########################################
      - name: Comment Code Quality Summary on PR
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ✅ **Code Quality Check Summary**

            ### 🔍 Test Cases
            | **Success** | **Failure** |
            | :---------: | :---------: |
            | ${{ steps.rspec.outputs.passed }} | ${{ steps.rspec.outputs.failed }} |

            ### 🧹 Linter
            ${{ steps.rubocop.outputs.summary }}
