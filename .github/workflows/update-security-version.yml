name: Update SECURITY.md with New Version

on:
  pull_request:
    paths:
      - 'lib/console_kit/version.rb'

permissions:
  contents: write
  pull-requests: write

jobs:
  update-security-md:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'

      - name: Get current version from version.rb
        id: version
        run: |
          VERSION_LINE=$(grep VERSION lib/console_kit/version.rb)
          VERSION=$(echo $VERSION_LINE | grep -oE "[0-9]+\.[0-9]+\.[0-9]+")
          echo "Detected version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Update SECURITY.md
        run: |
          NEW_VERSION="${{ steps.version.outputs.version }}"
          SECURITY_FILE="SECURITY.md"

          echo "New version: $NEW_VERSION"

          # Exit if version already exists in any form
          if grep -qE "^\|[[:space:]]*$NEW_VERSION[[:space:]]*\|" "$SECURITY_FILE"; then
            echo "Version $NEW_VERSION already present. Skipping update."
            exit 0
          fi

          # Change current :white_check_mark: to :x: only on the supported version line
          awk '
            BEGIN { OFS=FS="|" }
            /^\|[[:space:]]*[0-9]+\.[0-9]+\.[0-9]+[[:space:]]*\|/ {
              gsub(/^[ \t]+|[ \t]+$/, "", $2)
              if ($3 ~ /:white_check_mark:/) $3 = " :x: "
            }
            { print }' "$SECURITY_FILE" > tmpfile && mv tmpfile "$SECURITY_FILE"

          # Insert the new version line after the header
          awk -v new_ver="$NEW_VERSION" '
            BEGIN {
              inserted = 0
              header_seen = 0
              dash_line_seen = 0
            }
            {
              print
              if ($0 ~ /^\|[[:space:]]*Version[[:space:]]*\|[[:space:]]*Supported[[:space:]]*\|$/) {
                header_seen = 1
              } else if (header_seen && $0 ~ /^\|[[:space:]]*-+/) {
                dash_line_seen = 1
              } else if (header_seen && dash_line_seen && !inserted) {
                printf "| %-7s | :white_check_mark: |\n", new_ver
                inserted = 1
              }
            }
          ' "$SECURITY_FILE" > tmpfile && mv tmpfile "$SECURITY_FILE"

      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(security): update SECURITY.md for version bump"
